Pg create_root { 10, root }

// Pg create_child { 5, 'root, c1 }
// Pg create_child { 15, 'root, c2 }

// Pg create_child { 2, 'c1, c1_c1 }
// Pg create_child { 8, 'c1, c1_c2 }
Pg insert { 5, 'root }
Pg insert { 15, 'root }
Pg insert { 2, 'root }
Pg insert { 8, 'root }

Pg traverse { 'root }

!

@create_root ... Nil => val, Nil => res_addr
    c1 = (alloc 2) + 0
    alloc 1 => c1 + 0
    0 => c1 + 0
    'val => c1 + 1
    c1 => 'res_addr
    Ret

@create_child ... Nil => val, Nil => parent_addr, Nil => res_addr
    c1 = (alloc 2) + 0
    alloc 1 => c1 + 0
    'parent_addr => c1 + 0
    'val => c1 + 1
    c1 => 'res_addr
    Ret

@insert ... Nil => val, Nil => node
    node_addr = 'node
    node_val = '(node_addr + 1)
    P { 'val == node_val } Ret |

    children = getRefs node_addr
    left = 0
    right = 0
    L { 'children, 'Nil, P { 'i /= 0 } => i } b
        child_addr = '('i + 1)
        child_val = '(child_addr + 1)
        P { child_val < node_val } left = child_addr | right = child_addr
    @b ...

    is_left = 'val < node_val

    P { is_left } case_left | case_right

    @case_left ...
        P { left == 0 } case_create_left | case_insert_left
        @case_create_left ...
            Pg create_child { 'val, node_addr, left_new }
            end
        @case_insert_left ...
            Pg insert { 'val, left }
            end

    @case_right ...
        P { right == 0 } case_create_right | case_insert_right
        @case_create_right ...
            Pg create_child { 'val, node_addr, right_new }
            end
        @case_insert_right ...
            Pg insert { 'val, right }
            end

    @end ...
    Ret

@traverse ... Nil => node
    node_addr = 'node
    node_val = '(node_addr + 1)

    children = getRefs node_addr
    left = 0
    right = 0
    L { 'children, 'Nil, P { 'i /= 0 } => i } b
        child_addr = '('i + 1)
        child_val = '(child_addr + 1)
        P { child_val < node_val } left = child_addr | right = child_addr
    @b ...

    P { left /= 0 } case_left | case_left_end
    @case_left ...
        Pg traverse { left }
    @case_left_end ...

    print node_val

    P { right /= 0 } case_right | case_right_end
    @case_right ...
        Pg traverse { right }
    @case_right_end ...
    Ret